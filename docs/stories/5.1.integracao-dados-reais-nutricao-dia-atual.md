# História 5.1: Integração de Dados Reais de Nutrição Baseados no Dia Atual

**Status:** Draft

## História

**As a** usuário do aplicativo Allen,
**I want** ver minhas refeições planejadas reais para o dia atual da semana na aba de nutrição,
**so that** eu possa seguir meu plano nutricional personalizado ao invés de dados fictícios.

## Contexto da História

**Integração com Sistema Existente:**
- Integra com: Tabela `meal_plans` no Supabase e componentes UI existentes
- Tecnologia: Next.js API Routes, TypeScript, Supabase
- Segue padrão: Hook personalizado para gerenciamento de estado + API routes
- Pontos de contato: `useMealPlan.tsx`, `NutricaoTab.tsx`, `/api/nutrition/day-meals/route.ts`

## Critérios de Aceitação

### Requisitos Funcionais

1. **Detecção Automática do Dia Atual:** O sistema deve automaticamente identificar o dia da semana atual (ex: "tuesday", "wednesday") e buscar apenas as refeições desse dia.

2. **Busca de Dados por Usuário:** A API deve buscar apenas as refeições do usuário logado na tabela `meal_plans` filtrando por `user_id` e `day_of_week`.

3. **Agrupamento de Refeições:** Todas as refeições do dia atual devem ser agrupadas e exibidas no segundo card "Plano de Refeições de Hoje" (breakfast, lunch, dinner, snacks).

4. **Cálculo de Macros Diários:** O primeiro card deve mostrar a soma total de calorias, proteínas, carboidratos e gorduras de todas as refeições do dia.

5. **Estrutura de Dados Mantida:** Os dados devem manter a mesma interface `Meal[]` para compatibilidade com componentes existentes.

### Requisitos de Integração

6. A funcionalidade existente de "Plano Semanal" continua funcionando sem alterações
7. Os componentes `MealCard` e `MacroGoalsCard` seguem o mesmo padrão de renderização
8. A integração com modais de detalhes de refeição mantém comportamento atual

### Requisitos de Qualidade

9. Implementação coberta por testes apropriados na API route
10. Tratamento de erro quando usuário não possui plano para o dia atual
11. Loading states implementados durante busca de dados

## Tarefas / Subtarefas

- [ ] **Tarefa 1: Criar API Route para Buscar Refeições do Dia** (AC: 1,2,3)
  - [ ] Criar `/app/api/nutrition/day-meals/route.ts`
  - [ ] Implementar lógica para detectar dia da semana atual
  - [ ] Implementar query Supabase filtrando por `user_id` e `day_of_week`
  - [ ] Agrupar refeições por `meal_type` (breakfast, lunch, dinner)
  - [ ] Mapear dados para interface `Meal[]`

- [ ] **Tarefa 2: Calcular Macros Totais do Dia** (AC: 4)
  - [ ] Somar calorias totais de todas as refeições do dia
  - [ ] Somar proteínas, carboidratos e gorduras
  - [ ] Retornar dados consolidados na API response

- [ ] **Tarefa 3: Modificar Hook useMealPlan** (AC: 5,6,7)
  - [ ] Substituir dados hardcoded por fetch da API
  - [ ] Implementar loading states
  - [ ] Implementar error handling
  - [ ] Manter interface existente `Meal[]` e `MealPlan`
  - [ ] Preservar funcionalidade de plano semanal

- [ ] **Tarefa 4: Tratamento de Cenários Edge** (AC: 10)
  - [ ] Implementar fallback quando usuário não tem plano para o dia
  - [ ] Mensagem amigável "Você ainda não tem refeições planejadas para hoje"
  - [ ] Handling de erros de conexão com banco

- [ ] **Tarefa 5: Testing e Validação** (AC: 9,11)
  - [ ] Testes unitários para API route
  - [ ] Testes de integração para hook modificado
  - [ ] Validação de regressão em funcionalidades existentes

## Notas de Desenvolvimento

### Informações Relevantes da Source Tree

- `lib/database.types.ts`: Contém tipo `meal_plans` com estrutura completa
- `types/dashboard.ts`: Interface `Meal` e `NutricaoTabProps` já definidas
- `components/dashboard/tabs/NutricaoTab.tsx`: Component principal que receberá os dados
- `hooks/dashboard/useMealPlan.tsx`: Hook atual com dados hardcoded para modificar

### Estrutura da Tabela meal_plans

```typescript
{
  id: string
  user_id: string  
  day_of_week: string // 'monday', 'tuesday', etc.
  meal_type: string   // 'breakfast', 'lunch', 'dinner'
  calories: number
  protein: string
  carbs: string  
  fat: string
  foods: string[]
  created_at: string
}
```

### Mapeamento de Dados

```typescript
// De meal_plans para Meal interface
{
  meal: meal_type,        // 'breakfast' -> 'Breakfast'
  calories: calories,     // number
  protein: protein,       // string com 'g'
  carbs: carbs,          // string com 'g'  
  fat: fat,              // string com 'g'
  foods: foods           // string[]
}
```

### Lógica de Dia da Semana

```typescript
// Mapear dia atual para formato do banco
const daysMap = {
  0: 'sunday',
  1: 'monday', 
  2: 'tuesday',
  3: 'wednesday',
  4: 'thursday',
  5: 'friday',
  6: 'saturday'
};

const currentDay = daysMap[new Date().getDay()];
```

### Estrutura da API Response

```typescript
// GET /api/nutrition/day-meals
{
  success: boolean;
  data: {
    currentDay: string;
    totalCalories: number;
    totalProtein: string;
    totalCarbs: string;
    totalFat: string;
    meals: Meal[];
  };
  error?: string;
}
```

### Testing

- Testes de API route em `/app/api/nutrition/day-meals/route.test.ts`
- Mocks do Supabase para testes isolados
- Validação de mapeamento de dados correto
- Testes de cenários edge (usuário sem plano, erro de conexão)

### Padrões a Seguir

- Error handling: Seguir padrão de outras API routes no projeto
- Loading states: Usar padrão dos hooks existentes em `/hooks/dashboard/`
- Tipos TypeScript: Manter compatibilidade com interfaces em `/types/dashboard.ts`
- Supabase queries: Seguir padrão de outros hooks que fazem fetch

## Notas Técnicas

**Abordagem de Integração:**
- Hook `useMealPlan` será modificado para fazer fetch real da API
- Nova API route `/api/nutrition/day-meals` para buscar refeições do dia
- Mapeamento de dados da tabela `meal_plans` para interface `Meal`

**Principais Restrições:**
- Não alterar estrutura da tabela `meal_plans` existente
- Manter compatibilidade com componentes UI atuais
- Preservar funcionalidade de plano semanal

**Avaliação de Risco:**
- **Risco Principal:** Quebra de compatibilidade com componentes UI existentes
- **Mitigação:** Manter exatamente a mesma interface `Meal[]` e testar regressão
- **Rollback:** Reverter hook para dados hardcoded em caso de problemas

## Definição de Pronto

- [ ] Requisitos funcionais atendidos completamente
- [ ] Requisitos de integração verificados sem regressões
- [ ] Funcionalidade existente testada sem regressões
- [ ] Código segue padrões existentes do projeto
- [ ] Testes passando (existentes e novos)
- [ ] Tratamento de erros implementado
- [ ] Loading states funcionando corretamente

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-27 | 1.0 | História criada com requisitos completos para integração de dados reais de nutrição | Sarah (PO) |

## Dev Agent Record

*Esta seção será preenchida pelo agente de desenvolvimento durante a implementação*

### Agent Model Used
*A ser preenchido pelo dev agent*

### Debug Log References
*A ser preenchido pelo dev agent*

### Completion Notes List
*A ser preenchido pelo dev agent*

### File List
*A ser preenchido pelo dev agent*

## QA Results

*Resultados da revisão QA do agente QA após implementação concluída*
